// Prisma schema for Google Tempo (NextAuth + Google tokens)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]

  googleAccessToken  String?
  googleRefreshToken String?
  googleTokenExpiry  DateTime?

  // Onboarding
  onboardingCompleted Boolean   @default(false)
  onboardingStep      Int       @default(0) // 0 = pas commencé, 1-7 = étapes, 8 = terminé
  preferences         UserPreferences?

  // Relations gamification
  userProgress     UserProgress?
  conversations    Conversation[]
  preparationTrees PreparationTree[]
  agentMemories    AgentMemory[]
  quests           Quest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// PRÉFÉRENCES UTILISATEUR (ONBOARDING)
// ============================================

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Activités prioritaires (multi-select)
  priorityActivities String[] // ['studies', 'sport', 'pro', 'personal']
  studySubjects      String[] // ['Mathématiques', 'Physique', ...]
  sportDiscipline    String?  // 'running', 'cycling', etc.

  // Savoirs-être (3 choix parmi la liste France Travail)
  targetSoftSkills String[] // ['punctuality', 'perseverance', 'rigor', ...]

  // Notifications
  dailyNotificationTime String @default("08:00")
  messageTone           String @default("supportive") // 'supportive' | 'pepTalk' | 'lightTrashTalk'

  // Intégrations sport (optionnel)
  sportIntegrations String[] // ['strava', 'garmin', ...]

  // Consentement contenu promotionnel/adapté
  acceptPromotionalContent Boolean @default(false)
  acceptPersonalizedOffers Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// GAMIFICATION & PROGRESSION
// ============================================

model UserProgress {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // XP & Niveaux (gamification)
  xp    Int @default(0)
  level Int @default(1)

  // Points par domaine (analyse rétroactive)
  totalPoints   Int @default(0)
  currentLevel  Int @default(1)
  studiesPoints Int @default(0)
  sportPoints   Int @default(0)
  proPoints     Int @default(0)

  // Streaks événementiels
  currentStreak           Int       @default(0)
  longestStreak           Int       @default(0)
  lastEventValidationDate DateTime?

  // Stats globales
  totalActions          Int @default(0)
  totalTasksCreated     Int @default(0)
  totalTasksCompleted   Int @default(0)
  totalQuizzesCompleted Int @default(0)
  eventsCompleted       Int @default(0)

  // Analyse rétroactive
  retroactiveAnalysisDone Boolean   @default(false)
  retroactiveAnalysisDate DateTime?

  // Relations
  skillProgress   UserSkillProgress[]
  taskValidations TaskValidation[]
  quizzes         Quiz[]
  xpHistory       XpHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([level])
}

model XpHistory {
  id             String       @id @default(cuid())
  userProgressId String
  userProgress   UserProgress @relation(fields: [userProgressId], references: [id], onDelete: Cascade)

  amount     Int // XP gagné
  actionType String // 'task_created', 'task_completed', 'quiz_completed'
  eventId    String? // ID de l'événement Google Calendar associé
  multiplier Float   @default(1.0) // Multiplicateur (ex: 1.5 pour questionnaire)

  createdAt DateTime @default(now())

  @@index([userProgressId])
  @@index([createdAt])
  @@index([userProgressId, createdAt]) // Index composite pour requêtes fréquentes
}

// ============================================
// COMPÉTENCES (Structure modifiable)
// ============================================

model SkillFamily {
  id         String  @id @default(cuid())
  name       String  @unique
  color      String // Couleur hex pour le radar chart
  icon       String? // Nom de l'icône (lucide-react)
  order      Int // Ordre d'affichage
  isActive   Boolean @default(true)
  autoDetect Boolean @default(true) // Détection automatique depuis événements
  keywords   String // JSON array: ["math", "sciences", ...]

  details  SkillDetail[]
  progress UserSkillProgress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([order])
}

model SkillDetail {
  id       String      @id @default(cuid())
  familyId String
  family   SkillFamily @relation(fields: [familyId], references: [id], onDelete: Cascade)

  name        String
  keywords    String // JSON array pour association automatique
  description String?

  progress   UserSkillProgress[]
  activities Activity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([familyId])
}

model UserSkillProgress {
  id           String        @id @default(cuid())
  userId       String
  userProgress UserProgress? @relation(fields: [userId], references: [userId], onDelete: Cascade)

  skillFamilyId String
  skillFamily   SkillFamily @relation(fields: [skillFamilyId], references: [id], onDelete: Cascade)

  skillDetailId String?
  skillDetail   SkillDetail? @relation(fields: [skillDetailId], references: [id], onDelete: Cascade)

  level Int @default(0) // 0-100 pour le radar chart
  xp    Int @default(0) // XP spécifique à cette compétence

  lastActivityAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, skillFamilyId, skillDetailId])
  @@index([userId])
  @@index([skillFamilyId])
}

model Activity {
  id            String      @id @default(cuid())
  skillDetailId String
  skillDetail   SkillDetail @relation(fields: [skillDetailId], references: [id], onDelete: Cascade)

  eventId  String? // ID de l'événement Google Calendar
  type     String // 'task_created', 'task_completed', 'quiz_completed'
  xpEarned Int     @default(0)

  taskValidationId String?         @unique
  taskValidation   TaskValidation? @relation(fields: [taskValidationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([skillDetailId])
  @@index([eventId])
  @@index([createdAt])
}

// ============================================
// VALIDATION DE TÂCHES
// ============================================

model TaskValidation {
  id           String        @id @default(cuid())
  userId       String
  userProgress UserProgress? @relation(fields: [userId], references: [userId], onDelete: Cascade)

  eventId    String   @unique // ID de l'événement Google Calendar
  eventTitle String
  eventDate  DateTime

  completed   Boolean   @default(false)
  validatedAt DateTime?

  activity Activity?

  // Données de validation
  notes       String? // Notes optionnelles de l'utilisateur
  dismissed   Boolean   @default(false)
  dismissedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([eventId])
  @@index([completed])
  @@index([eventDate])
  @@index([userId, eventDate]) // Index composite pour filtres fréquents
}

// ============================================
// QUESTIONNAIRES IA
// ============================================

model QuizSeries {
  id     String @id @default(cuid())
  userId String

  name         String // Ex: "Révision Mathématiques - Série 1/4"
  totalQuizzes Int    @default(4)
  currentQuiz  Int    @default(1) // 1, 2, 3, 4

  goalEventId String? // Événement objectif associé
  context     String? // Contexte JSON pour l'agent IA

  quizzes Quiz[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([goalEventId])
}

model Quiz {
  id           String        @id @default(cuid())
  userId       String
  userProgress UserProgress? @relation(fields: [userId], references: [userId], onDelete: Cascade)

  seriesId String?
  series   QuizSeries? @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  eventId    String // Événement associé
  eventTitle String

  // Résultats
  score          Int     @default(0) // Score sur 10
  totalQuestions Int     @default(10)
  completed      Boolean @default(false)

  // Données du questionnaire (générées par l'agent IA)
  questions QuizQuestion[]
  context   String? // JSON: contexte utilisé pour générer le quiz

  completedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([eventId])
  @@index([seriesId])
  @@index([completed])
}

model QuizQuestion {
  id     String @id @default(cuid())
  quizId String
  quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  order         Int // Ordre dans le questionnaire (1-10)
  question      String
  options       String // JSON array: ["option1", "option2", ...]
  correctAnswer Int // Index de la bonne réponse (0-based)

  userAnswer Int? // Réponse de l'utilisateur
  isCorrect  Boolean? // null si pas encore répondu
  answeredAt DateTime?

  explanation String? // Explication après correction

  createdAt DateTime @default(now())

  @@index([quizId])
  @@index([order])
}

// ============================================
// HISTORIQUE DE CONVERSATIONS
// ============================================

model Conversation {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title      String? // Titre généré automatiquement (première question)
  isArchived Boolean @default(false)

  messages ConversationMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isArchived])
  @@index([updatedAt])
}

model ConversationMessage {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role    String // 'user' | 'assistant' | 'system'
  content String

  // Métadonnées
  toolCalls String? // JSON: appels d'outils si assistant
  action    String? // Action détectée (ex: 'create_event')
  metadata  String? // JSON: métadonnées additionnelles

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

// ============================================
// ARBRES DE PRÉPARATION (Persistance)
// ============================================

model PreparationTree {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  treeId      String // ID unique de l'arbre (ex: "examen-math")
  goalEventId String   @unique // ID de l'événement objectif (Google Calendar)
  goalTitle   String
  goalDate    DateTime

  // Source de détection
  detectionMethod String // 'annotation' | 'ai' | 'manual'

  branches PreparationBranch[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, treeId])
  @@index([userId])
  @@index([goalEventId])
  @@index([goalDate])
}

model PreparationBranch {
  id     String          @id @default(cuid())
  treeId String
  tree   PreparationTree @relation(fields: [treeId], references: [id], onDelete: Cascade)

  branchEventId String   @unique // ID de l'événement branche (Google Calendar)
  branchTitle   String
  branchDate    DateTime

  order Int // Ordre chronologique

  createdAt DateTime @default(now())

  @@index([treeId])
  @@index([branchEventId])
  @@index([branchDate])
}

// ============================================
// MÉMOIRE CONTEXTUELLE POUR L'AGENT IA
// ============================================

model AgentMemory {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Type de mémoire
  memoryType String // 'quiz_context', 'task_pattern', 'preference', etc.

  // Données
  key     String // Clé unique pour ce type de mémoire
  value   String // JSON: valeur de la mémoire
  context String? // JSON: contexte additionnel

  // Expiration
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, memoryType, key])
  @@index([userId])
  @@index([memoryType])
  @@index([expiresAt])
}

// ============================================
// QUETES
// ============================================

model Quest {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  description String
  xpReward    Int
  
  progress    Int      @default(0)
  total       Int
  
  type        String   // "DAILY" | "WEEKLY"
  status      String   @default("PENDING") // "PENDING" | "COMPLETED"
  
  skillId     String?  // ID optionnel pour lier à une compétence (ex: nom de la matière)
  
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}
